---
title: 分布式文件系统
date: 2018-01-22 15:12:06
tags:
	- 分布式
---
分布式文件系统的主要功能有两个：
一，存储文档、图像、视频等Blob（Binary large object）类型数据；二，作为分布式表格系统的持久化层

分布式文件系统中，最著名的是Google的GFS和Hadoop的HDFS，因此下文中主要以这二者为例，采用QA的方式。<!--more-->

## 1.GFS整体结构是怎样，其中角色各自承担的任务？
GFS（HDFS的整体结构和GFS几乎一致）主要有以下三种角色：
>a) Master（主控服务器）：负责维护系统的元数据，包括文件及数据块命名空间、文件到数据块的映射（一个文件可能会被切割成多个数据块，当读取某一文件时，需要知道文件由哪些数据块组成）、数据块位置信息等；同时也负责系统的全局控制，如数据块回收、数据块复制等；另外，也负责与数据块服务器的心跳等。

Master在对文件划分为数据块时，会为每个数据块创建一个64位全局唯一的句柄。

>b) ChunkServer（数据块服务器）：主要用于存储数据块，以Linux文件的形式将数据块存储在磁盘中

ChunkServer会对存储的数据维持校验和。


>c) Client（客户端）：提供给应用程序访问接口。

GFS Client不缓存文件数据，只缓存主控服务器中获取的元数据。

## 2.GFS和HDFS的数据块为什么划分成64M？
64M的数据块，确实远远大于一般的文件系统的数据块大小，但是选择一个大的数据块，能提供很多好处：
>a) 减少了Client与Master的交互：在同一个数据块内的读写操作只需要client在开始阶段询问master一次关于数据块位置信息即可，尤其是对于顺序读写超大文件，效果非常显著。

>b) 减小网络负载：使用一个大的数据块，client可以在一个数据块上完成更多的操作，它可以通过维持一个到数据块服务器的TCP长连接，减少网络管理量。

>c) 减少元数据的存储：数据块越大，对于同一个文件而言，其需要保存的元数据就越少。这样，当元数据较少时，我们可以将其存储在内存里，可以带来其他好处。

>缺陷：文件较小时，其会被保存在一个数据块里。这样，当大量对该文件的请求到来时，很容易出现热点问题（系统局部过载）。当然，对于该问题，可以采用增加冗余份数等策略。

## 3.HDFS如何删除多余副本数据？
如果系统的设置是标准的3副本策略，但发生某些情况后，系统中的A数据副本变成了5份，那么系统需要对多余的2份数据进行清除动作。

[1] 哪些情况会导致系统中产生多余的副本？
>a) 节点重新上线：如果一个数据块节点下线，会导致大批量的数据块丢失，而这些数据块就会在整个系统中进行重新拷贝。但是，一旦下线的节点取消下线，则之前已经拷贝生成的数据必然会成为多余的数据副本；

>b) 副本数重新设置：如果系统当前的副本数设置为3，那么A数据就会存在3份副本；当某一用户通过API设置副本数为1时，则系统中A副本就会多出2份；

>c) 新添加的数据块记录丢失

[2] 如何处理多余的副本？

* 定位多余的副本

>对于数据副本块，找到其所在的节点列表；

>对于该数据块的节点列表，划分为2类：节点上拥有超过1个副本和节点上恰好只有1个副本。优先选择节点中多于1个副本的节点进行多于副本删除；（例如X1节点有2个副本，X2节点有2个副本，X3节点有1个副本，则肯定先选择X1或者X2节点进行多于副本删除）

>对于节点上副本数相同的，则优先选取可用空间少的节点。(例如X1节点有1个副本(10G可用空间)，X2节点有1个副本（100G可用空间），X3节点有1个副本（2G可用空间），X4节点有1个副本（23G可用空间），则肯定先选择X3节点进行多于副本删除，因为删除后可以释放出更多的可用空间)

>将挑选出的节点从候选节点列表中删除

* 处理多余的副本

>已经获取到需要删除的副本和其对应所在的节点信息，只需要将其加入到无效数据块列表后，不久该数据块将会被清除